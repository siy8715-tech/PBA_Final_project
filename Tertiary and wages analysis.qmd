---
title: "First visualization"
author: "Group 1 - Gresa and Zoe"
format:
  html:
    self-contained: true
    toc: true
    toc-depth: 2
    toc-location: left
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE )
require(dplyr)
require(knitr)
require(tibble)
require(kableExtra)
require(tidyverse)
require(gapminder)
require(ggplot2)
require(readr)
require(readxl)
require(tidyr)
require(scales)
require(patchwork)

```

## Question 1

### What is the distribution of educational attainment (primary, secondary, tertiary) across countries?

```{r}
library(tidyverse)
library(readxl)

#Read the file 
url_attain <- "https://raw.githubusercontent.com/siy8715-tech/PBA_Final_project/1a085025d6ec250ad6e81aa8da3816e7ebc73a79/data/attainment_2023.xlsx"

temp <- tempfile(fileext = ".xlsx")
download.file(url_attain, temp, mode = "wb")

attainment_raw <- read_excel(temp, skip = 7)


#Rename the needed columns 
attainment_clean <- attainment_raw %>%
  select(
    Country = `Educational attainment level...1`,
    Year    = `Educational attainment level...2`,
    `Below upper secondary education`,
    `Upper secondary or post-secondary non-tertiary education`,
    `Tertiary education`
  ) %>%
  filter(!Country %in% c("Reference area", "Time period: 2024", NA))

#Make numeric
attainment_clean <- attainment_clean %>%
  mutate(across(
    c(`Below upper secondary education`,
      `Upper secondary or post-secondary non-tertiary education`,
      `Tertiary education`),
    ~ readr::parse_number(as.character(.))
  ))

#Keep 8 countries 
my_countries <- c("France","Germany","Japan","Korea","Spain","Sweden","United Kingdom","United States")

attainment_long <- attainment_clean %>%
  filter(Country %in% my_countries) %>%
  pivot_longer(
    cols = c(
      `Below upper secondary education`,
      `Upper secondary or post-secondary non-tertiary education`,
      `Tertiary education`
    ),
    names_to  = "Education_Level",
    values_to = "Percent"
  ) %>%
  mutate(
    Education_Level = recode(Education_Level,
      "Below upper secondary education" = "Below upper secondary",
      "Upper secondary or post-secondary non-tertiary education" = "Upper secondary",
      "Tertiary education" = "Tertiary"
    )
  )

attainment_with_totals <- attainment_long %>%
  group_by(Country) %>%
  mutate(total = sum(Percent, na.rm = TRUE)) %>%
  ungroup()

missing_fill <- attainment_with_totals %>%
  group_by(Country) %>%
  summarise(Missing = 100 - sum(Percent, na.rm = TRUE), .groups = "drop") %>%
  filter(Missing > 0) %>%
  transmute(Country, Education_Level = "Missing data", Percent = Missing)

attainment_final <- attainment_with_totals %>%
  select(Country, Education_Level, Percent) %>%
  bind_rows(missing_fill) %>%
  # ---- This controls STACK order (bottom -> top) ----
  mutate(
    Education_Level = factor(
      Education_Level,
      levels = c("Tertiary", "Upper secondary", "Below upper secondary", "Missing data")
    )) 
    
ggplot(attainment_final, aes(x = Country, y = Percent, fill = Education_Level)) +
  geom_col() +
  labs(
    title    = "Educational Attainment of Adults (Age 25â€“64) â€“ 2024",
    subtitle = "Share of population by highest level completed",
    x = NULL,
    y = "Percent of population",
    fill = "Highest level",
    caption = "Source: OECD Education Attainment (2024)"
  ) +
  scale_fill_manual(
    breaks = c("Tertiary", "Upper secondary", "Below upper secondary", "Missing data"),
    values = c(
      "Below upper secondary" = "#E57373",
      "Upper secondary"       = "#64B5F6",  
      "Tertiary"              = "#81C784",  
      "Missing data"          = "grey70"
    )
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right"
  )

```

Explanation: This graph shows the share of tertiary education graduates (college and university level) by field of study for 8 countries in 2023. The data represent the share of each countryâ€™s population by their highest level of completed education, divided into Below upper secondary, Upper secondary, Tertiary, and Missing data. Overall, the chart reveals that tertiary education (green) represents the largest share of the adult population in most countries, particularly in Korea, the United States, and Sweden, where over half of adults have completed higher education.\
Countries such as Spain and France show a more balanced distribution, with substantial proportions of adults having attained upper secondary education (blue). On the other hand, Japan has a segment of data marked as Missing (gray), which indicates unavailable or unreported values for that year or category. This emphasizes that while most OECD members provide complete data, some variation in data coverage still exists. Overall, the visualization highlights the strong correlation between national development and higher educational attainment, reflecting that countries with a higher share of tertiary-educated adults also tend to have lower proportions of adults without upper secondary education.

## Question 2

### Which fields of study (majors) are most common among tertiary graduates?

```{r}
library(readxl)
library(tidyverse)

#Read data 
url_grad <- "https://raw.githubusercontent.com/siy8715-tech/PBA_Final_project/1a085025d6ec250ad6e81aa8da3816e7ebc73a79/data/graduates_by_field.xlsx"

temp <- tempfile(fileext = ".xlsx")
download.file(url_grad, temp, mode = "wb")

grads_raw <- read_excel(temp, skip = 7)

graduates_clean <- grads_raw %>%
  mutate(
    Country_raw = `(EDUCATION_FIELD) Field of education...1`,
    # extract the part after ") "
    Country = sub("^\\([^\\)]+\\)\\s*", "", Country_raw)
  ) %>%
  select(
    Country,
    `Education` = `(F01) Education (broad field level)`,
    `Arts and humanities` = `(F02) Arts and humanities`,
    `Social sciences, journalism and information` = `(F03) Social sciences, journalism and information`,
    `Business, administration and law` = `(F04) Business, administration and law`,
    `Natural sciences, mathematics and statistics` = `(F05) Natural sciences, mathematics and statistics`,
    `ICT` = `(F06) Information and Communication Technologies (ICTs) (broad field level)`,
    `Engineering, manufacturing and construction` = `(F07) Engineering, manufacturing and construction`,
    `Health and welfare` = `(F09) Health and welfare (broad field level)`
        # skipping Agriculture, Services, STEM total, etc., to keep the chart readable
  )

graduates_clean <- graduates_clean %>%
  filter(
    !Country %in% c("Reference area", NA)
  )

my_countries <- c(
  "France",
  "Germany",
  "Sweden",
  "Spain",
  "United States",
  "United Kingdom",
  "Japan",
  "Korea"
)

graduates_clean <- graduates_clean %>%
  filter(Country %in% my_countries)

#Columns are numeric
graduates_clean <- graduates_clean %>%
  mutate(across(
    c(
      `Education`,
      `Arts and humanities`,
      `Social sciences, journalism and information`,
      `Business, administration and law`,
      `Natural sciences, mathematics and statistics`,
      `ICT`,
      `Engineering, manufacturing and construction`,
      `Health and welfare`
    ),
    ~ as.numeric(.)
  ))

#Field-of-study per country
graduates_long <- graduates_clean %>%
  pivot_longer(
    cols = c(
      `Education`,
      `Arts and humanities`,
      `Social sciences, journalism and information`,
      `Business, administration and law`,
      `Natural sciences, mathematics and statistics`,
      `ICT`,
      `Engineering, manufacturing and construction`,
      `Health and welfare`
    ),
    names_to = "Field_of_study",
    values_to = "Percent"
  ) %>%
  mutate(
    Country = case_when(
      Country == "United States"  ~ "USA",
      Country == "United Kingdom" ~ "UK",
      TRUE ~ Country
    )
  )
ggplot(graduates_long,
       aes(x = Field_of_study,
           y = Percent,
           fill = Field_of_study)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ Country, ncol = 4) +
  labs(
    title = "Distribution of Tertiary 2023",
    subtitle = "Field of Education",
    x = "Field of study",
    y = "Percent of graduates",
    caption = "Source: OECD â€“ Tertiary graduates by field of education (2023)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    strip.text = element_text(face = "bold"),
    axis.text.y = element_text(size = 8)
  )

```

Explanation: The chart illustrates the distribution of tertiary graduates by field of education across eight OECD countries; France, Germany, Japan, Korea, Spain, Sweden, the United Kingdom, and the United States for the year 2023. Each horizontal bar represents the percentage of graduates within a specific field of study, showing how education systems and economic priorities differ between countries. Across most countries, Business, administration and law accounts for the largest share of tertiary graduates, indicating the continuing dominance of business-related fields in higher education. This trend is especially strong in France, Germany, and the United Kingdom, where these fields make up over a quarter of total graduates. Engineering, manufacturing and construction also shows a notable share, particularly in Germany, Japan, and Korea, reflecting these countriesâ€™ strong industrial and technological sectors. Conversely, fields such as Arts and humanities and Social sciences show moderate proportions, while ICT (Information and Communication Technologies), though smaller, is growing, especially visible in Korea and Sweden, which have strong digital economies. The field of Health and welfare represents a significant share in countries like France and Spain, likely linked to strong healthcare systems and social service sectors. Overall, the data highlight that economic structure and national priorities shape the educational choices of students, with business and engineering dominating in industrial and service-oriented economies, and health or ICT emerging as specialized strengths in others.

## Question 3

### What are the mean and median wages by education level in each country (adjusted for PPP)?

```{r}
#| fig-format: png
library(readxl)
library(tidyverse)
library(readr)
library(stringr)

#Load File
url_wage <- "https://raw.githubusercontent.com/siy8715-tech/PBA_Final_project/1a085025d6ec250ad6e81aa8da3816e7ebc73a79/data/Wage2023.xlsx"

temp <- tempfile(fileext = ".xlsx")
download.file(url_wage, temp, mode = "wb")

message("Using file from: ", url_wage)

w0 <- read_excel(temp, skip = 7, col_types = "text")
nm <- names(w0)

#8 countries
my_countries <- c("France","Germany","Japan","Korea","Spain","Sweden","United Kingdom","United States")

country_col <- {
  scores <- sapply(nm, function(cn) sum(na.omit(w0[[cn]]) %in% my_countries))
  nm[which.max(scores)]
}
if (length(country_col) == 0 || is.na(country_col) || max(sapply(nm, function(cn) sum(na.omit(w0[[cn]]) %in% my_countries))) == 0) {
  # fallback: first column
  country_col <- nm[1]
}

unit_col <- {
  has_kw <- function(v) sum(str_detect(tolower(na.omit(v)), "us|dollar|ppp|convert"))
  scores <- sapply(nm, function(cn) has_kw(w0[[cn]]))
  nm[which.max(scores)]
}

price_col <- {
  has_kw <- function(v) sum(str_detect(tolower(na.omit(v)), "price|constant|current"))
  scores <- sapply(nm, function(cn) has_kw(w0[[cn]]))
  if (max(scores) > 0) nm[which.max(scores)] else NA_character_
}

#Column most likely to be the numeric value 
value_col <- {
  nnums <- sapply(nm, function(cn) sum(!is.na(parse_number(w0[[cn]]))))
  nm[which.max(nnums)]
}

wages <- w0 %>%
  transmute(
    Country   = str_trim(.data[[country_col]]),
    Unit      = .data[[unit_col]],
    PriceBase = if (!is.na(price_col)) .data[[price_col]] else NA_character_,
    Wage_PPP  = parse_number(.data[[value_col]])
  ) %>%
  filter(
    !is.na(Country), !is.na(Wage_PPP),
    str_detect(Unit, "(?i)US\\s*dollars"),
    str_detect(Unit, "(?i)PPP\\s*converted")
  ) %>%
  # Prefer constant prices if present
  filter(is.na(PriceBase) | str_detect(PriceBase, "(?i)constant"))

wages <- wages %>%
  filter(Country %in% my_countries) %>%
  mutate(Country = recode(Country, "United Kingdom"="UK", "United States"="USA"))

if (nrow(wages) == 0) {
  cat("DEBUG names(w0):\n"); print(names(w0))
  cat("\nDEBUG head(w0):\n"); print(head(w0, 10))
  stop("No rows left after filtering. The script couldnâ€™t locate PPP USD rows or country names. See DEBUG above.")
}

#Mean & median across the 8 countries 
mean_wage   <- mean(wages$Wage_PPP, na.rm = TRUE)
median_wage <- median(wages$Wage_PPP, na.rm = TRUE)

cat("Mean wage (PPP-adjusted):  ", round(mean_wage, 0), "\n")
cat("Median wage (PPP-adjusted):", round(median_wage, 0), "\n")

#Plot 
ggplot(wages, aes(x = reorder(Country, Wage_PPP), y = Wage_PPP)) +
  geom_col(fill = "#64B5F6") +
  geom_hline(yintercept = mean_wage,   colour = "#388E3C", linetype = "dashed", size = 1) +
  geom_hline(yintercept = median_wage, colour = "#D32F2F", linetype = "dotted", size = 1) +
  coord_flip() +
  labs(
    title    = "Mean and Median Annual Wages (PPP-adjusted, 2023)",
    subtitle = "US dollars, PPP converted and Constant prices",
    x = "Country",
    y = "Annual wage (PPP-adjusted USD)",
    caption = "Source: OECD â€“ Average annual wages (PPP-adjusted USD, 2023)\nDashed = Mean | Dotted = Median"
  ) +
  theme_minimal(base_size = 11) +
  theme(axis.text.y = element_text(size = 10))
```

Explanation: The bar chart compares the mean and median annual wages (PPP-adjusted, 2023) across seven OECD countries, the United States, Germany, the United Kingdom, Sweden, Spain, Korea, and Japan. Wages are shown in purchasing power parity (PPP)-adjusted US dollars, which accounts for cost-of-living differences between countries. The United States has the highest average annual wage, exceeding 80,000 PPP-adjusted USD, followed by Germany and the United Kingdom, both with mean wages above 60,000 USD. In contrast, Japan and Korea record the lowest averages, reflecting comparatively lower compensation levels after cost-of-living adjustments. The vertical lines represent the overall mean (green dashed line) and median (red dotted line) wage across all selected countries. The proximity of these lines suggests a relatively balanced distribution, though countries like the USA pull the mean slightly upward due to their higher wages. Overall, the chart demonstrates that wage levels are highest in advanced Western economies, while East Asian countries maintain lower, though relatively consistent, earnings once adjusted for purchasing power. This pattern highlights both productivity and cost-of-living differences across OECD members.

## Question 4

### Relative earnings of workers compared to those with upper secondary attainment, by educational attainment and age group

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)

url_RE <- "https://raw.githubusercontent.com/siy8715-tech/PBA_Final_project/1a085025d6ec250ad6e81aa8da3816e7ebc73a79/data/RelativeEarnings_Copy.xlsx"

temp_RE <- tempfile(fileext = ".xlsx")

download.file(url_RE, temp_RE, mode = "wb")

message("Using file from: ", url_RE)

raw <- read_excel(temp_RE, sheet = "Sheet1", skip = 6, col_names = TRUE)
names(raw) <- c(
  "country",
  "below_upper_25_34",
  "below_upper_45_54",
  "below_upper_25_64",
  "upper_25_34",
  "upper_45_54",
  "upper_25_64",
  "post_secondary_25_34",
  "post_secondary_45_54",
  "post_secondary_25_64",
  "short_cycle_25_34",
  "short_cycle_45_54",
  "short_cycle_25_64",
  "bachelor_25_34",
  "bachelor_45_54",
  "bachelor_25_64",
  "master_25_34",
  "master_45_54",
  "master_25_64",
  "total_25_34",
  "total_45_54",
  "total_25_64"
)

data_long <- raw %>%
  pivot_longer(
    cols = -country,
    names_to = "education_age",
    values_to = "earnings"
  ) %>%
  mutate(
#Separate the education type
    education = case_when(
      str_detect(education_age, "below_upper") ~ "Below upper secondary",
      str_detect(education_age, "upper_") ~ "Upper secondary",
      str_detect(education_age, "post_secondary") ~ "Post-secondary non-tertiary",
      str_detect(education_age, "short_cycle") ~ "Short-cycle tertiary",
      str_detect(education_age, "bachelor") ~ "Bachelor or equivalent",
      str_detect(education_age, "master") ~ "Master/Doctoral or equivalent",
      str_detect(education_age, "total") ~ "Tertiary total",
      TRUE ~ "Other"
    ),
#Extract the age group
    age_group = case_when(
      str_detect(education_age, "25_34") ~ "25-34 year-olds",
      str_detect(education_age, "45_54") ~ "45-54 year-olds",
      str_detect(education_age, "25_64") ~ "25-64 year-olds",
      TRUE ~ "Other"
    ),

    country = recode(country,
                     "United Kingdom" = "UK",
                     "United States" = "US")
  ) %>%
  select(country, education, age_group, earnings)

head(data_long)

data_long4 <- data_long %>%
  mutate(education4 = case_when(
    education %in% c("Short-cycle tertiary",
                     "Bachelor or equivalent",
                     "Master/Doctoral or equivalent",
                     "Tertiary total") ~ "Tertiary",
    TRUE ~ education
  ))

data_long4 <- data_long4 %>%
  mutate(
    earnings_label = ifelse(is.na(earnings), "Missing", "Reported")
  )

library(tidyr)
library(dplyr)
library(ggplot2)

data_complete <- data_long4 %>%
  complete(country, age_group, education4)

#Add label for missing vs reported
data_complete <- data_complete %>%
  mutate(
    earnings_status = ifelse(is.na(earnings), "Missing", "Reported"),
    earnings = ifelse(is.na(earnings), 0, earnings)  # shows gray bar at baseline (0)
  )

#Plot 
ggplot(data_complete, aes(x = country, y = earnings, fill = age_group)) +
  geom_col(
    aes(fill = ifelse(earnings_status == "Missing", "Missing", age_group)),
    position = position_dodge(width = 0.75),
    width = 0.7,
    color = "gray40"
  ) +
  facet_wrap(~ education4, ncol = 2, scales = "free_y") +
  scale_fill_manual(
    values = c(
      "Missing" = "gray70",
      "25-34 year-olds" = "#1f77b4",
      "45-54 year-olds" = "#2ca02c",
      "25-64 year-olds" = "#ff7f0e"
    ),
    name = "Age Group"
  ) +
  labs(
  title = "Relative Earnings by Education Level in 2023",
  subtitle = "Comparison of average earnings by education level and age group",
  x = "Country", 
  y = "Relative Earnings"
) +
theme_minimal(base_size = 6) +
theme(
  legend.position = "bottom",
  axis.text.x = element_text(angle = 20, hjust = 1, size = 10),
  strip.text = element_text(face = "bold", size = 8),
  plot.title = element_text(face = "bold", size = 8),
  plot.subtitle = element_text(size = 11, color = "gray30"),
  panel.grid.minor = element_blank(),

  # ðŸ”¹ Add these extra lines for better PDF spacing and readability
  axis.text.y = element_text(size = 8),
  legend.text = element_text(size = 8),
  legend.title = element_text(size = 13, face = "bold"),
  panel.spacing = unit(1, "lines")
)



```

Explanation: The chart compares relative earnings by education level and age group across five OECD countries; Korea, Spain, Sweden, the United Kingdom, and the United States for the year 2023. Relative earnings are expressed as an index where individuals with upper secondary education are set to 1 (or 100), allowing comparison across different levels of education. Overall, the results confirm a strong positive relationship between education level and income. Individuals with tertiary education earn the highest relative wages in all countries, especially in the United States and Spain, where earnings exceed twice the level of those with upper secondary education. In contrast, individuals with below upper secondary education consistently earn less, with the lowest relative earnings observed in Korea and Spain. Across age groups, differences in earnings are relatively small, indicating that education level has a stronger impact on earnings than age. The post-secondary non-tertiary category shows limited data availability (missing in several countries), suggesting that this level of education is either less common or not separately reported in some OECD members. Overall, the chart highlights that higher education yields a significant earnings premium across all observed countries, reinforcing the economic value of tertiary qualifications.



## Question 5

### Within tertiary education, how do earnings differ by field of study?

```{r load data for earning by field of study }
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(httr)

url <- "https://raw.githubusercontent.com/siy8715-tech/PBA_Final_project/main/data/x78130.xlsx"

GET(url, write_disk(tf <- tempfile(fileext = ".xlsx")))

dt_earning_field <- read_excel(tf, sheet = 12, range = "B44:H63")

glimpse(dt_earning_field)

al_country <- c(
  "France",
  "Germany",
  "Sweden",
  "Spain",
  "United States",
  "United Kingdom",
  "Japan",
  "Korea"
)

dt_earning_field <- dt_earning_field %>%
  pivot_longer(
    cols = c(
      `Arts and humanities, social sciences, journalism and information`,
      `Science, Technology, Engineering et Mathematics (STEM)`,
      `Business, administration and law`,
      `Health and welfare`
    ),
    names_to = "Field of Study",
    values_to = "Relative Earning"
  ) %>%
  select("Country",`Field of Study`,`Relative Earning`) %>%
  filter(Country %in% al_country)

glimpse(dt_earning_field)

dt_earning_field$Country <- factor(
  dt_earning_field$Country,
  levels = c(
    "United States", "United Kingdom",       # English-speaking
    "France", "Germany", "Sweden", "Spain",  # Europe
    "Japan", "Korea"                         # Asia
  )
)

dt_earning_field$`Field of Study` <- factor(
  dt_earning_field$`Field of Study`,
  levels = c(
    "Science, Technology, Engineering et Mathematics (STEM)",
    "Business, administration and law",
    "Health and welfare",
    "Arts and humanities, social sciences, journalism and information"
  )
)

dt_earning_field<- dt_earning_field %>%
  mutate(`Field of Study` = recode(`Field of Study`,
    "Science, Technology, Engineering et Mathematics (STEM)" = "Science, Technology, Engineering, Mathematics",
    "Arts and humanities, social sciences, journalism and information" = "Arts and humanities, social sciences"
  ),
  Country = recode(Country,
    "United States" = "US",
    "United Kingdom" ="UK"
  )
  )

earn_field <- ggplot(
  dt_earning_field,
  aes(x = Country, y = `Relative Earning`, 
      shape = `Field of Study`,
      color = `Field of Study`)
) +
  scale_shape_manual(values = c(16, 17, 15, 18)) +
  geom_point(size = 3, position = position_jitter(height = 0.8, width = 0)) +
  scale_color_viridis_d(option = "C", end = 0.9) +  
  labs(
    title = "Relative Earnings by Field of Study across Countries",
    subtitle = "25-64 year-old full-time full-year workers, percentage difference from average earnings",
    caption = "Source: OECD, Education at a Glance Database, https://stats.oecd.org/",
    x = NULL,
    y = "Relative earning (% from average tertiary adult )",
    color = "Field of Study",
    shape = "Field of Study"
  ) +
  theme_minimal(base_size = 10) +
  theme(
    legend.position = "top",
    legend.box = "vertical",
    legend.title = element_text(size = 7),
    legend.text  = element_text(size = 7),
    axis.text.y  = element_text(size = 8),
    axis.text.x  = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    plot.caption = element_text(size = 6),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 8, hjust = 0.5)
  ) +
  guides(
    shape = guide_legend(nrow = 2, byrow = TRUE)
  ) +
  scale_y_continuous(
    breaks = seq(-30, 30, by = 10),
    limits = c(-30, 30),
    labels = label_percent(accuracy = 1, scale = 1)  
  )

earn_field

```

Across advanced economies, STEM and business degrees yield significant positive wage premiums, especially in Anglo-Saxon markets, whereas health and arts fields tend to underperform. This highlights persistent labor-market stratification by field of study and suggests that socially essential occupations, particularly in health, may be structurally undervalued.

## Question 6

### How much wage inequality exists within the same field of study between countries?

```{r}

field_mean <- dt_earning_field %>%
  group_by(`Field of Study`) %>%
  summarise(mu = mean(`Relative Earning`, na.rm = TRUE), .groups = "drop")

field_facet <- earn_field +
  geom_hline(yintercept = 0, linetype = "dotted", linewidth = 0.4) +
  geom_hline(data = field_mean, aes(yintercept = mu, color = `Field of Study`),
             linetype = "dashed", linewidth = 0.6, show.legend = FALSE) +
  facet_wrap(~ `Field of Study`, ncol = 2) +
  guides(color = "none", shape = "none") +
  labs(
    title = "Within-field wage gaps across countries",
    subtitle = "Each panel is a field of study"
  ) +
  theme(
    strip.text = element_text(size = 6, face = "bold"),     
    strip.background = element_rect(fill = "#f2f2f7", colour = NA),
    axis.text.x = element_text(angle = 90, hjust = 1)
  )

field_facet
```

While STEM and business graduates consistently earn wage premiums across countries, the relative earnings of arts and health graduates vary more widely â€” ranging from modest penalties to substantial wage disadvantages depending on the country. This suggests that non-STEM labor market returns are more sensitive to national institutional and labor-market conditions, indicating greater cross-country inequality within these fields.

## Question 7

### Is there any correlation between field of study in tertiary education and wages?

```{r,fig.width=10, fig.height=10}

url_grads <- "https://raw.githubusercontent.com/siy8715-tech/PBA_Final_project/main/data/graduates_by_field.xlsx"

GET(url_grads, write_disk(tmpf <- tempfile(fileext = ".xlsx")))

grads_raw <- read_excel(tmpf, skip = 7)

grads_re <- grads_raw %>%
  mutate(
    Country_raw = `(EDUCATION_FIELD) Field of education...1`,
    # extract the part after ") "
    Country = sub("^\\([^\\)]+\\)\\s*", "", Country_raw),
    `Arts and humanities, social sciences` = rowSums(across(5:6, ~ as.numeric(.)), na.rm = TRUE),
    `Business, administration and law` = as.numeric(.[[7]]),
    `Science, Technology, Engineering, Mathematics` = rowSums(across(8:10, ~ as.numeric(.)), na.rm = TRUE),
    `Health and welfare` = as.numeric(.[[11]])
  ) %>%
  pivot_longer(
    cols = c(
      `Arts and humanities, social sciences`,
      `Science, Technology, Engineering, Mathematics`,
      `Business, administration and law`,
      `Health and welfare`
    ),
    names_to = "Field of Study",
    values_to = "Percentage of Students"
  ) %>%
  select(
    Country,
    "Field of Study",
    "Percentage of Students"
  ) %>%
  mutate(
    Country = recode(Country,
    "United States" = "US",
    "United Kingdom" ="UK"
  ))

dt_earn_perc_field <- dt_earning_field %>%
  left_join(grads_re, 
            by = c("Country", "Field of Study")) %>%
  select(Country, `Field of Study`,`Relative Earning`,`Percentage of Students`)

dt_earn_perc_field$Country <- factor(
  dt_earn_perc_field$Country,
  levels = c(
    "US", "UK",       # English-speaking
    "France", "Germany", "Sweden", "Spain",  # Europe
    "Japan", "Korea"                         # Asia
  )
)

corr_country <- dt_earn_perc_field %>%
  group_by(Country) %>%
  summarise(
    corr = cor(`Relative Earning`, `Percentage of Students`,
               use = "complete.obs", method = "pearson")
  )

#Find relative earning and grad population corr by country

df_plot <- dt_earn_perc_field %>%
  left_join(corr_country, by = "Country")

ggplot(df_plot,
       aes(x = `Percentage of Students`, y = `Relative Earning`, color = `Field of Study`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(aes(group = 1, color = NULL), method = "lm", se = FALSE) +  
  labs(x = "Percentage of Students", y = "Relative Earning",
       title = "Earnings vs Tertiary Share by Country") +
  facet_wrap(~ Country, ncol = 2, scales = "fixed") +
  geom_text(
    data = corr_country,
    aes(x = -Inf, y = Inf, label = paste0("r = ", round(corr, 2))),
    hjust = -0.1, vjust = 1.2,
    color = "black", size = 4,
    inherit.aes = FALSE
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "top",
    legend.box = "vertical",
    legend.title = element_text(size = 9),
    legend.text  = element_text(size = 9),
    axis.text.y  = element_text(size = 10),
    axis.text.x  = element_text(size = 10),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    plot.caption = element_text(size = 8),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  ) +
guides(
    color = guide_legend(nrow = 2, byrow = TRUE)
  )



```

This figure plots the relationship between each fieldâ€™s share of tertiary graduates and its relative earnings across countries. In most countries, fields with a larger share of graduates tend to have higher earnings, reflected in the positive slope of the fitted lines. \\ However, the Arts and humanities field consistently sits well below the trend and appears furthest from the fitted line. This indicates that its labor-market returns are less aligned with enrollment patterns compared with other disciplines. In other words, even where Arts graduates represent a meaningful share of students, their relative earnings remain low. \\ Because the Arts field behaves differently from STEM, business, and healthâ€”where earnings premiums track more closely with participationâ€”it weakens the overall correlation. This likely reflects the fact that returns to non-STEM degrees depend more on country-specific labor-market structures, cultural funding, and institutional factors, leading to greater cross-country variation. For this reason, we next re-estimate the correlation excluding Arts, to examine whether the underlying relationship becomes stronger once this outlier field is removed.

```{r,fig.width=10, fig.height=10}
# Exclude Arts and humanities, social sciences for correlation
df_no_art <- df_plot %>%
  filter(`Field of Study` != "Arts and humanities, social sciences")

corr_country_no_art <- df_no_art %>%
  group_by(Country) %>%
  summarise(
    corr = cor(`Percentage of Students`, `Relative Earning`,
               use = "complete.obs", method = "pearson")
  )

ggplot(df_no_art,
       aes(x = `Percentage of Students`, y = `Relative Earning`, color = `Field of Study`)) +
  geom_point(alpha = 0.7) +
  geom_smooth(aes(group = 1, color = NULL), method = "lm", se = FALSE) +  
  labs(x = "Percentage of Students", y = "Relative Earning",
       title = "Earnings vs Tertiary Share by Country") +
  facet_wrap(~ Country, ncol = 2, scales = "fixed") +
  geom_text(
    data = corr_country_no_art,
    aes(x = -Inf, y = Inf, label = paste0("r = ", round(corr, 2))),
    hjust = -0.1, vjust = 1.2,
    color = "black", size = 4,
    inherit.aes = FALSE
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "top",
    legend.box = "vertical",
    legend.title = element_text(size = 9),
    legend.text  = element_text(size = 9),
    axis.text.y  = element_text(size = 10),
    axis.text.x  = element_text(size = 10),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    plot.caption = element_text(size = 8),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, hjust = 0.5)
  ) +
guides(
    color = guide_legend(nrow = 2, byrow = TRUE)
  )

```

Excluding the Arts field reveals a strong and robust positive relationship between tertiary specialization and earnings across countries. This suggests that, unlike Artsâ€”which has highly variable returns across national labor marketsâ€”STEM and business fields show more uniform, market-driven patterns of reward internationally, reinforcing the idea that labor-market demand for these skills is globally persistent.